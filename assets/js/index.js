async function fetchGeoData(e){var t=e.lat,a=e.lon,t=await(await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${t}&lon=${a}&format=json&zoom=18&addressdetails=1`)).json();e.state=t.address.state_district||t.address.province,e.state||(e.state=t.address.state)}function refineState(e){-1<e.state.indexOf(" ")&&(e.state=e.state.split(" ").pop()),"Gerona"===e.state&&(e.state="Girona"),"Lérida"===e.state&&(e.state="Lleida")}!function(){var t=!0,a=document.getElementById("toggle"),o=(a.addEventListener("click",function(e){t=t?(O.unsubscribe({channels:[z]}),!(a.value="Iniciar")):(A(),a.value="Parar",!0)},!1),{}),r="#63A69F",n="#FF8586",s="#DECEB3",i={type:"positive",icon:"grinning-face.png"},d={type:"positive",icon:"smiling-face.png"},c={type:"positive",icon:"heart-eyed-happy-face.png"},l={type:"negative",icon:"pensive-face.png"},u={type:"negative",icon:"crying-face.png"},p={type:"negative",icon:"angry-face.png"},g={type:"negative",icon:"sick-face.png"},m={type:"neutral",icon:"neutral-face.png"},f={type:"positive",icon:"mapa_actividad_estrella.png"},b=["excellent","amazing","beautiful","nice","marvelous","magnificent","fabulous","astonishing","fantastic","peaceful","fortunate","brilliant","glorious","cheerful","gracious","grateful","splendid","superb","honorable","thankful","inspirational","ecstatic","victorious","virtuous","proud","wonderful","lovely","delightful","excelente","increíble","hermos","agradable","maravillos","magnífic","fabulos","asombros","fantástic","pacífic","afortunad","brillante","glorios","alegre","gentil","agradecid","espléndid","excelente","honorable","agradecid","inspirador","extátic","victorios","virtuos","orgullos","maravillos","encantador","positiv","spectacul"," si ","mejor"],h=["happy","lucky","awesome","excited","fun","amusing","amused","pleasant","pleasing","glad","enjoy","jolly","delightful","joyful","joyous",":-)",":)",":-D",":D","=)","☺","feliz","afortunado","increíble","emocionad","divertid","entretenid","divertid","agradable","agradable","alegre","disfrut","alegre","encantador"," alegre "," alegre ","amig","perfect","😀","😃","😄","😁","😆","😅","😂","🤣","☺️","😊","😇","🙂","🙃","😉","😌","😍","🥰","😘","😗","😙","😚","😋","😛","😝","😜","🤪","🤨","🧐","🤓","😎","🤩","🥳"],v=["amor","adora","feliz","sincer","cariños","adorable","cariñ","kawaii","casad","comprom","amar","adora","favorit","sincer","cariños","adorable","cariñ","kawaii","casad","comprom","❤","💕","💞","💓","💗","💖","💘","💝","💟","💜","💛","💚","💙","🧡","🖤","💯","💋","💌","💍","💎","👑","👒","👠","👡","👢","👞","👟","👙","👗","👘","👚","👕","👖","👔","👛","👜","💼","🎒","👝","👛","👓","🕶","🌂","☂","🎩","🎓","👑","👒","👟","👞","👡","👠","👢","👕","👔","👚","👗","👙","👘","👖","👘","👙","👚","👛","👜","💼","🎒","👝","👛","👓","🕶","🌂","☂","🎩","🎓","👑","👒","👟","👞","👡","👠","👢","👕","👔","👚","👗","👙","👘","👖","👘","👙","👚","👛","👜","💼","🎒","👝","👛","👓","🕶","🌂","☂","🎩","🎓","👑","👏","orgull"],y=["unhappy","bad","sorry","annoyed","dislike","anxious","ashamed","cranky","crap","crappy","envy","awful","bored","boring","bothersome","bummed","burned","chaotic","defeated","devastated","stressed","disconnected","discouraged","dishonest","doomed","dreadful","embarrassed","evicted","freaked out","frustrated","stupid","guilty","hopeless","horrible","horrified","humiliated","ignorant","inhumane","cruel","insane","insecure","nervous","offended","oppressed","overwhelmed","pathetic","powerless","poor","resentful","robbed","screwed","infeliz","mal","lo siento","molest","aversión","ansios","avergonzad","irritable","mierda","chivo","envidia","horrible","aburrid","molest","abatid","quemad","caótic","derrotad","devastad","estresad","desconectad","desalentad","deshonest","condenad","terrible","avergonzad","desalojad","aterrad","frustrad","estúpid","culpable","sin esperanza","horrible","horrorizad","humillad","ignorante","inhuman","cruel","insan","insegur","nervios","ofendid","oprimid","abrumad","patétic","impotente","pobre","resentid","robad","jodid"," no ","peor","acoso","agresi","🤥","alert"],w=["sad","alone","anxious","depressed","disappointed","disappointing","sigh","sobbing","crying","cried","dumped","heartbroken","helpless","hurt","miserable","misunderstood","suicidal",":-(",":(","=(",";(","triste","solo","sola","ansios","deprimid","decepcionad","decepci","suspir","solloz","llora","llorando","dejad","desconsolad","indefens","herid","miserable","incomprendid","suicid"],x=["hate","damn","angry","betrayed","bitched","disgust","disturbed","furious","harassed","hateful","hostile","insulted","irritable","jealous"," rage ","pissed","odio","odia","maldic","enoj","traicion","disgust","perturb","furios","hostigad","odios","hostil","insultad","irritable","celos","rabia","cabread","odio","odia","maldic","enoj","traicion","disgust","perturb","furios","hostigad","odios","hostil","insultad","irritable","celos","rabia","cabread","odio","odia","maldic","enoj","traicion","disgust","perturb","furios","hostigad","odios","hostil","insultad","irritable","celos","rabia","cabread","odio","odia","maldic","enoj","traicion","disgust","perturb","furios","hostigad","odios","hostil","insultad","irritable","celos","rabia","cabread","odio","odia","maldic","enoj","traicion","disgust","perturb","furios","hostigad","odios","hostil","insultad","irritable","celos","rabia","cabread","odio","odia","maldic","enoj","traicion","disgust","perturb","furios","hostigad","odios","hostil","insultad","irritable","celos","rabia","cabread","odio","odia","maldic","enoj","traicion","disgust","perturb","furios","hostigad","odios","hostil","insultad","irritable","celos","rabia","cabread","odio","odia","maldic","enoj","traicion","disgust","perturb","furios","hostigad","odios","hostil","insultad","irritable","celos","rabia","cabread","odio","odia","maldic","enoj","traicion","disgust","perturb","fur"],j=["sick"," ill ","under weather","throw up","threw up","throwing up","puke","puking","pain","hangover","intoxicated","enfermo","bajo el clima","vomit","dolor","resaca","intoxicad","duele","tortur"],_=["nightspain","nightgranada","nightalmeria","nightsevilla","nighthuelva","nightcadiz","nightmalaga","nightjaen","nightcordoba","noche europea de los investigadores","noche europea de l@s investigador@s"],S=d3.geo.mercator().center([-3,41]).scale(3300).rotate([0,0]),k=d3.scale.linear().domain([0,15]).range(["#5b5858","#4f4d4d","#454444","#323131"]),e=d3.select("#map").append("svg").attr("width",950).attr("height",700),q=d3.geo.path().projection(S),L=e.append("g"),C=(d3.json("json/spain-province.json",function(e,t){L.selectAll("path").data(topojson.feature(t,t.objects.ESP_adm2).features).enter().append("path").attr("class",function(e){return"states "+e.properties.NAME_2}).attr("d",q).attr("fill",function(e,t){return k(t)})}),e.selectAll("image").data([0])),z="pubnub-twitter",O=new PubNub({subscribeKey:"sub-c-d00e0d32-66ac-4628-aa65-a42a1f0c493b"});function A(){O.addListener({message:function(e){var t;!e.message||(t=e.message)&&t.place&&t.lang&&"ES"===t.place.country_code&&(_.some(function(e){return-1!==t.text.toLowerCase().indexOf(e)})?D(t,f):b.some(function(e){return-1!==t.text.toLowerCase().indexOf(e)})?D(t,i):h.some(function(e){return-1!==t.text.toLowerCase().indexOf(e)})?D(t,d):v.some(function(e){return-1!==t.text.toLowerCase().indexOf(e)})?D(t,c):y.some(function(e){return-1!==t.text.toLowerCase().indexOf(e)})?D(t,l):w.some(function(e){return-1!==t.text.toLowerCase().indexOf(e)})?D(t,u):x.some(function(e){return-1!==t.text.toLowerCase().indexOf(e)})?D(t,p):j.some(function(e){return-1!==t.text.toLowerCase().indexOf(e)})?D(t,g):(console.log(t.text),D(t,m)))}}),O.subscribe({channels:[z]})}function D(e,i){!async function(e,t){var a={},i=e.place.full_name;a.city=i,a.state=e.place.name,a.name=e.user.name,a.screenname=e.user.screen_name,a.avatar=e.user.profile_image_url,a.tweet=e.text,a.id_str=e.id_str;var o=(i=new Date(parseInt(e.timestamp_ms))).toDateString().substr(4),i=12<i.getHours()?i.getHours()-12+":"+i.getMinutes()+" PM":i.getHours()+":"+i.getMinutes()+" AM;";a.timestamp=i+" - "+o,e.geo?(a.lat=e.geo.coordinates[0],a.lon=e.geo.coordinates[1]):(o=((i=e.place.bounding_box.coordinates[0])[0][0]+i[2][0])/2,e=(i[0][1]+i[2][1])/2,a.lat=e,a.lon=o),refineState(a);let r=!1;try{r=document.querySelector("."+a.state)}catch(e){console.log(e)}r||(await fetchGeoData(a),refineState(a)),t(a)}(e,function(e){document.querySelector(".emotion").style.backgroundImage="url(images/"+i.icon+")",document.querySelector(".button").href="https://twitter.com/"+e.screenname,document.querySelector(".header").style.backgroundImage="url("+e.avatar+")",document.querySelector(".name").textContent=e.name,document.querySelector(".screenname").textContent="@"+e.screenname,document.querySelector(".text").innerHTML=twemoji.parse(e.tweet.replace(/((https?|s?ftp|ssh)\:\/\/[^"\s\<\>]*[^.,;'">\:\s\<\>\)\]\!])/g,function(e){return'<a href="'+e+'" >'+e+"</a>"})),document.querySelector(".timestamp").textContent=e.timestamp,document.querySelector(".reply").href="https://twitter.com/intent/tweet?in_reply_to="+e.id_str,document.querySelector(".retweet").href="https://twitter.com/intent/retweet?tweet_id="+e.id_str,document.querySelector(".favorite").href="https://twitter.com/intent/favorite?tweet_id="+e.id_str,document.querySelector(".tweet").style.opacity=.9,document.querySelector("."+e.state)&&(o[e.state]=o[e.state]||{positive:0,negative:0},o[e.state][i.type]=(o[e.state][i.type]||0)+1,(t=document.querySelector("."+e.state)).style.fill=o[e.state].positive>o[e.state].negative?r:o[e.state].positive<o[e.state].negative?n:s,t.setAttribute("data-positive",o[e.state].positive),t.setAttribute("data-negative",o[e.state].negative));var t,a=S([e.lon,e.lat]);null!==a&&(a[0]=a[0]-13,a[1]=a[1]-13,C.enter().append("svg:image").attr("xlink:href","images/"+i.icon).attr("width","26").attr("height","26").attr("transform",function(e){return"translate("+a+")"}))})}A()}();